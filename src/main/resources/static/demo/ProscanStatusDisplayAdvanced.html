<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>PROSCAN Status Display</title>

    <script src="https://gfa-autodeploy.psi.ch:8443/wica.js" defer></script>
    <script src="https://gfa-autodeploy.psi.ch:8443/plotly-latest.min.js"></script>

</head>
<body>

<!--  <style>

       /* Extra small devices (portrait phones, less than 544px). There is no media query */
       /* since this is the default in Bootstrap because it is "mobile first" */
       html {font-size:1rem;} /*1rem = 16px*/
       /*

       Bootstrap 4 breakpoints
       */
       /* Small devices (landscape phones, 544px and up) */
       @media (min-width: 544px) {
           html {font-size:1.5rem;} /*1rem = 16px*/
       }

       /* Medium devices (tablets, 768px and up) The navbar toggle appears at this breakpoint */
       @media (min-width: 768px) {
           html {font-size:2rem;} /*1rem = 16px*/
       }

       /* Large devices (desktops, 992px and up) */
       @media (min-width: 992px) {
           html {font-size:2.5rem;} /*1rem = 16px*/
       }

       /* Extra large devices (large desktops, 1200px and up) */
       @media (min-width: 1200px) {
           html {font-size:3rem;} /*1rem = 16px*/
       }

       /* Basic element styling */

   </style> -->

<style>

    .MainStatus1 {
        background-color: darkgrey;
    }

    .MainStatus2 {
        background-color: darkgrey;
    }

    .TimeNow {
        background-color: darkgrey;
    }
    .Banner {
        background-color: darkgrey;
    }

    .OtherStatus1 {
        background-color: darkgrey;
    }

    .OtherStatus2 {
        background-color: darkgrey;
    }

    .MainPlot{
        background-color: darkgrey;
    }

    .BlockerStatus {
        background-color: darkgrey;
    }
    .Regulation {
        background-color: darkgrey;
    }
    .VDefCurve {
        background-color: darkgrey;
    }
    .MMAP5X {
        background-color: darkgrey;
    }
    .MMAP6Y {
        background-color: darkgrey;
    }
    .Environment {
        background-color: darkgrey;
    }
    .RPS-SSB {
        background-color: darkgrey;
    }
    .Mastership {
        background-color: darkgrey;
    }

</style>
<style>

    * {
        font-family: "Helvetica Neue",sans-serif;
        padding: 0;
        margin: 0;
        border:0;
    }

    body, html {
        height: 100%;
        width:100%;
        background-color: darkgrey;
    }

    /* Grid Definition */
    .TimeNow { grid-area: TimeNow; }
    .Banner { grid-area: Banner; }
    .Regulation { grid-area: Regulation; }
    .MainStatus1 { grid-area: MainStatus1; }
    .MainStatus2 { grid-area: MainStatus2; }
    .VDefCurve { grid-area: VDefCurve; }
    .OtherStatus1 { grid-area: OtherStatus1; }
    .OtherStatus2 { grid-area: OtherStatus2; }
    .MainPlot { grid-area: MainPlot; }
    .Environment { grid-area: Environment; }
    .BlockerStatus { grid-area: BlockerStatus; }
    .Mastership { grid-area: Mastership; }
    .MMAP5X { grid-area: MMAP5X; }
    .MMAP6Y { grid-area: MMAP6Y; }
    .RPS-SSB { grid-area: RPS-SSB; }

    .grid-container {
        display: grid;
        grid-template-columns: 3fr 3fr 9fr 3fr 3fr;
        grid-template-rows: 1fr 1.375fr 1.375fr 2.75fr 2.75fr 2.75fr 1fr;
        grid-gap: 1%;
        grid-template-areas:
                'TimeNow TimeNow Banner Regulation Regulation'
                'MainStatus1 MainStatus1 MainStatus1 VDefCurve VDefCurve'
                'MainStatus2 MainStatus2 MainStatus2 VDefCurve VDefCurve'
                'OtherStatus1 OtherStatus2 MainPlot MMAP5X MMAP6Y'
                'OtherStatus1 OtherStatus2 MainPlot Environment Environment'
                'OtherStatus1 OtherStatus2 BlockerStatus RPS-SSB RPS-SSB'
                'Mastership Mastership Mastership Mastership Mastership';
    }

    /* Grid Items */

    /* Reused components */
    .statusWidget {
        margin: 0.5rem;
        height: 1.2rem;
        width: 1.2rem;
    }

    .flex-new-row {
        width: 100%;
    }

    /* Extra small devices (portrait phones, less than 544px). There is no media query */
    /* since this is the default in Bootstrap because it is "mobile first" */
    html {
        font-size:1rem;
    } /*1rem = 16px*/

    .grid-container {
        height: 100%;
        width: 100%;
    }

    .timeNowContainer {
        display: flex;
        height: 100%;
    }

    .timeNow {
        justify-content: left;
        background-color: darkgrey;
        color: darkblue;
        font-size: 1.2rem;
        padding: 1rem;
    }

    .bannerContainer {
        display: flex;
        height: 100%;
        justify-content: center;
        background-color: darkgrey;
        align-items: center;
    }

    .banner {
        text-align: center;
        color: darkblue;
        font-size: 3rem;
        font-weight: 400;
        background-color: darkgrey;
    }

    .regulationContainer {
        display: flex;
        height: 100%;
        flex-flow: row nowrap;
        justify-content: space-around;
        align-items: center;
        background-color:  darkgrey;
        font-size: 1.2rem;
        margin: 1.2rem;
    }

    .regulationStatusItemLabel {
        background-color: darkgray;
        color: darkblue;
    }

    .regulationStatusItemValue {
        background-color: lightgray;
        color: black;
    }

    /* Main Status Items */
    .mainStatusItemContainer {
        display: flex;
        height: 100%;
        justify-content: space-around;
        flex-flow:row nowrap;
        align-content: stretch;
        align-items: center;
        font-size: 2rem;
        background-color: darkgrey;
    }

    .mainStatusItemLabel {
        background-color: darkgrey;
        color: black;
        flex: none;
        width: 9rem;
        margin:1.25rem;
        text-align: right;
    }

    .mainStatusItemValue {
        flex: 1 0 auto;
        background-color: lightgray;
        color: black;
        border: firebrick 5px solid;
        margin: 1.25rem;
        width: 9rem;
    }

    /* Other Status Items */
    .otherStatusItemContainer {
        display: flex;
        height: 100%;
        justify-content: space-around;
        flex-flow:column nowrap;
        align-content: stretch;
        align-items: stretch;
        margin-left:5px;
        font-size: 1.2rem;
    }

    .otherStatusItemLabel {
        flex: none;
        background-color: darkgrey;
        color: darkblue;
    }

    .otherStatusItemValue {
        flex: none;
        background-color: black;
        color: limegreen;
        text-align: right;
        border: darkgrey 5px solid;
    }

    /* Main Plot Status Items */
    .mainPlotContainer {
        display: grid;
        height: 100%;
    }

    #mainPlotContainerMainPlotHolder {
        grid-row-start: 1;
        grid-column-start: 1;
        z-index: 0;
        display: flex;
        height: 100%;
    }

    #mainPlotContainerAlarmWidgetHolder {
        grid-row-start: 1;
        grid-column-start: 1;
        z-index: 1;
        visibility: hidden;
        display: flex;
        text-align: center;
        justify-content: center;
        align-items: center;
    }

    #mainPlot {
        flex: 1 0 auto;
        overflow:hidden;
        background-color: lightgray;
    }

    #alarmWidget {
        font-size: 5rem;
        background-color: red;
    }

    /* Profile Monitor and Vertical Deflector Status Items */
    .mmap5xPlotContainer, .mmap6yPlotContainer, .vdefPlotContainer {
        display: flex;
        height: 100%;
        flex-flow: column nowrap;
        overflow:hidden;
    }

    #mmap5xPlot, #mmap6yPlot, #vdefPlot {
        flex: auto;

        background-color: lightgray;
    }

    .mmap5xLabel, .mmap6yLabel {
        flex:none;
        background-color: lightgray;
        text-align: center;
    }

    /* Blocker Status Items */
    .blockerStatusItemGridContainer {
        display: flex;
        height: 100%;
        flex-flow:row wrap;
    }

    .blockerStatusItemContainer {
        display: flex;
        flex-flow: column nowrap;
        flex: 1 0 32%;
        background-color: lightgray;
        color: darkblue;
        text-align: center;
        align-content: center;
        border: black 2px solid;
    }

    .blockerStatusItemHeader {
        font-size: 1.3rem;
    }

    .blockerStatusItemOpenState {
        justify-content: center;
        border: 4px solid firebrick;
        margin: 4px;
    }

    .blockerStatusItemPermissionContainer {
        display:flex;
        flex-flow: row nowrap;
        justify-content: space-around;
        background-color: lightgray;
    }

    .blockerStatusItemPermissionLabel {
        flex: 1 1 auto;
        margin-top:  auto;
        margin-bottom: auto;
        text-align:  left;
        background-color: lightgrey;
    }

    .blockerStatusItemPermissionWidget{
        margin: 0.5rem;
        height: 1.2rem;
        width: 1.2rem;
        background-color: lightgrey;
    }

    /* Env Status Items */
    .envStatusItemContainer {
        display:flex;
        height: 100%;
        background-color: lightgray;
        justify-content: space-around;
        flex-flow:row wrap;
        align-content: stretch;
        align-items: stretch;
    }

    .envStatusItemLabel {
        flex: 1 1 50%;
        background-color: lightgray;
        color: darkblue;
        text-align: center;
    }

    .envStatusItemValue {
        flex: 1 1 50%;
        background-color: lightgray;
        color: black;
        text-align: center;
    }

    /* Run Permit System / Safety Switch Box Status Items */
    .rpsSsbStatusItemContainer {
        height: 100%;
        display: flex;
        flex-flow: row wrap;
        justify-content: flex-start;
        background-color: lightgray;
    }

   .rpsSsbStatusItemHeader {
        color: darkblue;
        font-size: 1.5rem;
    }

    .rpsSsbStatusItemLabel {
        flex-flow: column ;
        width: 1em;
        flex: 2em;
        font-size: 1.4rem;
        color: black;
    }

    /* Mastership Status Items */
    .mastershipStatusItemContainer {
        display: flex;
        height: 100%;
        width: 100%;
        justify-content: center;
        flex-flow:row nowrap;
        font-size: 3rem;
        align-items: center;
    }

    .mastershipStatusItemLabel {
        color: darkblue;
        text-align: right;
        margin-right: 1rem;
    }

    .mastershipStatusItemValue {
        color: black;
        text-align: left;
        margin-left: 1rem;
    }

</style>

<div class="grid-container">

    <div class="TimeNow">
        <div class="timeNowContainer">
            <div class="timeNow" data-epics-channel="XPROSCAN:TIME:2">NC</div>
        </div>
    </div>

    <div class="Banner">
        <div class="bannerContainer">
            <div class="banner">Proscan Status</div>
        </div>
    </div>

    <div class="Regulation">
        <div class="regulationContainer">
            <div class="regulationStatusItemLabel">Regelung:</div>
            <div class="statusWidget" data-epics-channel="XPROREG:STAB:1" onchange="updateRegulationStatusWidget( event )"></div>
            <div class="regulationStatusItemValue" data-epics-channel="EMJCYV:STA3:2">NC</div>
            <div class="regulationStatusItemValue" data-epics-channel="EMJCYV:CTRL:1">NC</div>
        </div>
    </div>

    <div class="MainStatus1">
        <div class="mainStatusItemContainer">
            <div class="mainStatusItemLabel">MMAC3</div>
            <div class="statusWidget" data-epics-channel="MMAV6:IST:2" onchange="updateHvpsuOkWidget( event )"></div>
            <div class="mainStatusItemValue" data-epics-channel="MMAC3:STR:2">NC</div>
            <div class="mainStatusItemLabel">Vdef.</div>
            <div class="mainStatusItemValue" data-epics-channel="EMJCYV:IST:2">NC</div>
        </div>
    </div>
    <div class="MainStatus2">
        <div class="mainStatusItemContainer">
            <div class="mainStatusItemLabel">SOL</div>
            <div class="statusWidget"></div>
            <div class="mainStatusItemValue" data-epics-channel="MMAC:SOL:2">NC</div>
            <div class="mainStatusItemLabel">Degr.</div>
            <div class="mainStatusItemValue" data-epics-channel="DMAD1:IST:2">NC</div>
        </div>
    </div>

    <div class="VDefCurve">
        <div class="vdefPlotContainer" id="vdefPlot">
            <div id="vdefPlotDataX" data-epics-channel="PRO:REG2D:X:1"></div>
            <div id="vdefPlotDataY" data-epics-channel="PRO:REG2D:Y:1"></div>
        </div>
    </div>

    <div class="OtherStatus1">
        <div class="otherStatusItemContainer">
            <div class="otherStatusItemLabel">Kicker</div>
            <div class="otherStatusItemValue" data-epics-channel="AMAKI1:IST:2">NC</div>
            <div class="otherStatusItemLabel">HF</div>
            <div class="otherStatusItemValue" data-epics-channel="CMJSEV:PWRF:2">NC</div>
            <div class="otherStatusItemValue" data-epics-channel="CMJLL:SOLA:2">NC</div>
            <div class="otherStatusItemLabel">Extractor</div>
            <div class="otherStatusItemValue" data-epics-channel="EMJEC1V:IST:2">NC</div>
            <div class="otherStatusItemValue" data-epics-channel="EMJEC2V:IST:2">NC</div>
            <div class="otherStatusItemLabel">Hauptmagnet</div>
            <div class="otherStatusItemValue" data-epics-channel="AMJHS-I:IADC:2">NC</div>
            <div class="otherStatusItemLabel">Phase</div>
            <div class="otherStatusItemValue" data-epics-channel="MMJF:IST:2">NC</div>
            <div class="otherStatusItemLabel">Ionenquelle</div>
            <div class="otherStatusItemValue" data-epics-channel="IMJV:IST:2">NC</div>
            <div class="otherStatusItemValue" data-epics-channel="IMJI:IST:2">NC</div>
            <div class="otherStatusItemValue" data-epics-channel="IMJGF:IST:2">NC</div>
            <div class="otherStatusItemValue" data-epics-channel="XPROIONS:IST1:2">NC</div>
        </div>
    </div>

    <div class="OtherStatus2">
        <div class="otherStatusItemContainer">
            <div class="otherStatusItemLabel">QMA1/2/3</div>
            <div class="otherStatusItemValue" data-epics-channel="QMA1:IST:2">NC</div>
            <div class="otherStatusItemValue" data-epics-channel="QMA2:IST:2">NC</div>
            <div class="otherStatusItemValue" data-epics-channel="QMA3:IST:2">NC</div>
            <div class="otherStatusItemLabel">SMJ1x/2y</div>
            <div class="otherStatusItemValue" data-epics-channel="SMJ1X:IST:2">NC</div>
            <div class="otherStatusItemValue" data-epics-channel="SMJ2Y:IST:2">NC</div>
            <div class="otherStatusItemLabel">SMA1x/1y</div>
            <div class="otherStatusItemValue" data-epics-channel="SMA1X:IST:2">NC</div>
            <div class="otherStatusItemValue" data-epics-channel="SMA1Y:IST:2">NC</div>
            <div class="otherStatusItemLabel">Ph.Spalt 1/2</div>
            <div class="otherStatusItemValue" data-epics-channel="MMJP2:IST1:2">NC</div>
            <div class="otherStatusItemValue" data-epics-channel="FMJEPI:POS:2">NC</div>
            <div class="otherStatusItemValue" data-epics-channel="FMJEPI:BREI:2">NC</div>
            <div class="otherStatusItemValue" data-epics-channel="MMJP2:IST2:2">NC</div>
            <div class="otherStatusItemValue" data-epics-channel="FMJIPI:POS:2">NC</div>
            <div class="otherStatusItemValue" data-epics-channel="FMJIPI:BREI:2">NC</div>
        </div>
    </div>

    <div class="MainPlot">
        <div class = "mainPlotContainer">
            <div id="mainPlotContainerAlarmWidgetHolder">
                <div id="alarmWidget" data-epics-channel="PRO:CURRENTALARM:1" onchange="updateNoBeamAlarmWidget( event )">NC</div>
            </div>
            <div id="mainPlotContainerMainPlotHolder">
                <div id="mainPlot">
                    <div id="mainPlotBeamCurrentData" data-epics-channel="MMAC3:STR:2"></div>
                    <div id="mainPlotVDefVoltageData" data-epics-channel="EMJCYV:IST:2"></div>
                    <div id="mainPlotHFPowerData" data-epics-channel="CMJSEV:PWRF:2"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="BlockerStatus">
        <div class="blockerStatusItemGridContainer">
            <div class="blockerStatusItemContainer">
                <div class="blockerStatusItemHeader">BMA1</div>
                <div class="blockerStatusItemOpenState" data-epics-channel="BMA1:STA:2" onchange="updateStopperStatusWidget( event )">NC</div>
                <div class="blockerStatusItemPermissionContainer">
                    <div class="blockerStatusItemPermissionWidget" data-epics-channel="BMA1:STAR:2" onchange="updateRpsStopperPermissionWidget( event )"></div>
                    <div class="blockerStatusItemPermissionLabel" data-epics-channel="BMA1:STAR:2">RPS OK</div>
                </div>
                <div class="blockerStatusItemPermissionContainer">
                    <div class="blockerStatusItemPermissionWidget" data-epics-channel="BMA1:STAP:2" onchange="updatePassStopperPermissionWidget( event )"></div>
                    <div class="blockerStatusItemPermissionLabel" data-epics-channel="BMA1:STAP:2">PaSS OK</div>
                </div>
            </div>
            <div class="blockerStatusItemContainer">
                <div class="blockerStatusItemHeader">BME1 Gantry 1</div>
                <div class="blockerStatusItemOpenState" data-epics-channel="BME1:STA:2" onchange="updateStopperStatusWidget( event )">NC</div>
                <div class="blockerStatusItemPermissionContainer">
                    <div class="blockerStatusItemPermissionWidget" data-epics-channel="BME1:STAR:2" onchange="updateRpsStopperPermissionWidget( event )"></div>
                    <div class="blockerStatusItemPermissionLabel" data-epics-channel="BME1:STAR:2">RPS OK</div>
                </div>
                <div class="blockerStatusItemPermissionContainer">
                    <div class="blockerStatusItemPermissionWidget" data-epics-channel="BME1:STAP:2" onchange="updatePassStopperPermissionWidget( event )"></div>
                    <div class="blockerStatusItemPermissionLabel" data-epics-channel="BME1:STAP:2">PaSS OK</div>
                </div>
            </div>
            <div class="blockerStatusItemContainer">
                <div class="blockerStatusItemHeader">BMB1 Gantry 2</div>
                <div class="blockerStatusItemOpenState" data-epics-channel="BMB1:STA:2" onchange="updateStopperStatusWidget( event )">NC</div>
                <div class="blockerStatusItemPermissionContainer">
                    <div class="blockerStatusItemPermissionWidget" data-epics-channel="BMB1:STAR:2" onchange="updateRpsStopperPermissionWidget( event )"></div>
                    <div class="blockerStatusItemPermissionLabel" data-epics-channel="BMB1:STAR:2">RPS OK</div>
                </div>
                <div class="blockerStatusItemPermissionContainer">
                    <div class="blockerStatusItemPermissionWidget" data-epics-channel="BMB1:STAP:2" onchange="updatePassStopperPermissionWidget( event )"></div>
                    <div class="blockerStatusItemPermissionLabel" data-epics-channel="BMB1:STAP:2">PaSS OK</div>
                </div>
            </div>
            <div class="flex-new-row">
            </div>
            <div class="blockerStatusItemContainer">
                <div class="blockerStatusItemHeader">BMC1 OPTIS 2</div>
                <div class="blockerStatusItemOpenState" data-epics-channel="BMC1:STA:2" onchange="updateStopperStatusWidget( event )">NC</div>
                <div class="blockerStatusItemPermissionContainer">
                    <div class="blockerStatusItemPermissionWidget" data-epics-channel="BMC1:STAR:2" onchange="updateRpsStopperPermissionWidget( event )"></div>
                    <div class="blockerStatusItemPermissionLabel" data-epics-channel="BMC1:STAR:2">RPS OK</div>
                </div>
                <div class="blockerStatusItemPermissionContainer">
                    <div class="blockerStatusItemPermissionWidget" data-epics-channel="BMC1:STAP:2" onchange="updatePassStopperPermissionWidget( event )"></div>
                    <div class="blockerStatusItemPermissionLabel" data-epics-channel="BMC1:STAP:2">PaSS OK</div>
                </div>
            </div>
            <div class="blockerStatusItemContainer">
                <div class="blockerStatusItemHeader">BMD1 PIF</div>
                <div class="blockerStatusItemOpenState" data-epics-channel="BMD1:STA:2" onchange="updateStopperStatusWidget( event )">NC</div>
                <div class="blockerStatusItemPermissionContainer">
                    <div class="blockerStatusItemPermissionWidget" data-epics-channel="BMD1:STAR:2" onchange="updateRpsStopperPermissionWidget( event )"></div>
                    <div class="blockerStatusItemPermissionLabel" data-epics-channel="BMD1:STAR:2">RPS OK</div>
                </div>
                <div class="blockerStatusItemPermissionContainer">
                    <div class="blockerStatusItemPermissionWidget"></div>
                </div>
            </div>
            <div class="blockerStatusItemContainer">
                <div class="blockerStatusItemHeader">BMD2 Gantry 3</div>
                <div class="blockerStatusItemOpenState" data-epics-channel="BMD2:STA:2" onchange="updateStopperStatusWidget( event )">NC</div>
                <div class="blockerStatusItemPermissionContainer">
                    <div class="blockerStatusItemPermissionWidget" data-epics-channel="BMD2:STAR:2" onchange="updateRpsStopperPermissionWidget( event )"></div>
                    <div class="blockerStatusItemPermissionLabel" data-epics-channel="BMD2:STAR:2">RPS OK</div>
                </div>
                <div class="blockerStatusItemPermissionContainer">
                    <div class="blockerStatusItemPermissionWidget" data-epics-channel="BMD2:STAP:2" onchange="updatePassStopperPermissionWidget( event )"></div>
                    <div class="blockerStatusItemPermissionLabel" data-epics-channel="BMD2:STAP:2">PaSS OK</div>
                </div>
            </div>
        </div>
    </div>

    <div class="MMAP5X">
        <div class="mmap5xPlotContainer">
            <div id="mmap5xPlot">
                <div id="mmap5xPlotDataX" data-epics-channel="MMAP5X:PROF:2:P"></div>
                <div id="mmap5xPlotDataY" data-epics-channel="MMAP5X:PROF:2"></div>
            </div>
            <div class="mmap5xLabel" data-epics-channel="MMAP5X:SPB:2">NC</div>
        </div>
    </div>

    <div class="MMAP6Y">
        <div class="mmap6yPlotContainer">
            <div id="mmap6yPlot">
                <div id="mmap6yPlotDataX" data-epics-channel="MMAP6Y:PROF:2:P"></div>
                <div id="mmap6yPlotDataY" data-epics-channel="MMAP6Y:PROF:2"></div>
            </div>
            <div class="mmap6yLabel" data-epics-channel="MMAP6Y:SPB:2">NC</div>
        </div>
    </div>

    <div class="Environment">
        <div class="envStatusItemContainer">
            <div id="heizleistungDataId1" data-epics-channel="YMJHH:SPARB:2"></div>
            <div id="heizleistungDataId2" data-epics-channel="YMJHH:STR:2"></div>
            <div class="envStatusItemLabel">Schildkü 1:</div><div class="envStatusItemValue" data-epics-channel="YMJCS1K:IST:2">NC</div>
            <div class="flex-new-row"></div>
            <div class="envStatusItemLabel">Schildkü 2:</div><div class="envStatusItemValue" data-epics-channel="YMJCS2K:IST:2">NC</div>
            <div class="flex-new-row"></div>
            <div class="envStatusItemLabel">Heizleist.</div><div id="heizLeistungCalculator" class="envStatusItemValue">NC</div>
            <div class="flex-new-row"></div>
            <div class="envStatusItemLabel">He Level:  </div><div class="envStatusItemValue" data-epics-channel="YMJHL:IST:2">NC</div>
            <div class="flex-new-row"></div>
            <div class="envStatusItemLabel">He Druck:  </div><div class="envStatusItemValue" data-epics-channel="YMJHG:IST:2">NC</div>
            <div class="flex-new-row"></div>
            <div class="envStatusItemLabel">Bunker:    </div><div class="envStatusItemValue" data-epics-channel="YMJKKRT:IST:2">NC</div>
        </div>
    </div>

    <div class="RPS-SSB">
        <div class="rpsSsbStatusItemContainer">
            <div class="rpsSsbStatusItemHeader">RPS / Safety Switch Box</div>
            <div class="flex-new-row"></div>
            <div class="statusWidget" data-epics-channel="RPS-IQ:STA:1"  onchange="updateRunPermitSystemStatusWidget( event )"></div>
            <div class="statusWidget" data-epics-channel="UMJSSB:BIQX:1" onchange="updateSafetySwitchBoxStatusWidget( event )"></div>
            <div class="rpsSsbStatusItemLabel">Ionenquelle</div>
            <div class="flex-new-row"></div>
            <div class="statusWidget" data-epics-channel="RPS-HFRD:STA:1" onchange="updateRunPermitSystemStatusWidget( event )"></div>
            <div class="statusWidget" data-epics-channel="UMJSSB:BHRX:1"  onchange="updateSafetySwitchBoxStatusWidget( event )"></div>
            <div class="rpsSsbStatusItemLabel">HF reduziert</div>
            <div class="flex-new-row"></div>
            <div class="statusWidget" data-epics-channel="RPS-HF:STA:1"  onchange="updateRunPermitSystemStatusWidget( event )"></div>
            <div class="statusWidget" data-epics-channel="UMJSSB:BHFX:1" onchange="updateSafetySwitchBoxStatusWidget( event )"></div>
            <div class="rpsSsbStatusItemLabel">HF</div>
            <div class="flex-new-row"></div>
            <div class="statusWidget"></div>
            <div class="statusWidget" data-epics-channel="UMJSSB:BDEX:1" onchange="updateSafetySwitchBoxStatusWidget( event )"></div>
            <div class="rpsSsbStatusItemLabel">Ablenkplatte</div>
        </div>
    </div>

    <div class="Mastership">
        <div class="mastershipStatusItemContainer">
            <div class="mastershipStatusItemLabel">Mastership:</div>
            <div class="mastershipStatusItemValue" data-epics-channel="XPROSCAN:STAB:2">NC</div>
        </div>
    </div>

</div>

<script>

    function updateNoBeamAlarmWidget( event )
    {
        let widget = event.target;
        let channelValue = event.channelValue;

        // This test was taken from the caQtDm PROSCAN status display
        if ( parseFloat(channelValue) < 0.5 )
        {
            widget.style.visibility = "hidden";
            widget.textContent = "Beam OK";
        }
        else {
            widget.style.visibility = "visible";
            widget.textContent = "No Beam";
        }
    }

    function updateHvpsuOkWidget( event ) {
        // This test was taken from the caQtDm PROSCAN status display
        update_status_widget( event.target, parseFloat( event.channelValue ) > 0.9 * 1000  );
    }

    function updateRegulationStatusWidget( event ) {
        update_status_widget( event.target, parseInt( event.channelValue ) !== 0);
    }

    function updateStopperStatusWidget( event ) {
        let widget = event.target;
        let channelValue = event.channelValue;

        if ( channelValue.includes( "Offen" )) {
            widget.style.borderColor = "lime";
        }
        else {
            widget.style.borderColor = "red";
        }
        widget.textContent = channelValue;
    }

    function updateRpsStopperPermissionWidget( event )  {
        update_status_widget( event.target, ! event.channelValue.includes( "NOK" ) );
    }

    function updatePassStopperPermissionWidget( event )  {
        update_status_widget( event.target, ! event.channelValue.includes( "NOK" ) );
    }

    function updateRunPermitSystemStatusWidget( event )  {
        let status = parseInt( event.channelValue );

        // This test was taken from the caQtDm PROSCAN status display
        let bit0Set = ( status & (1 << 0) ) === (1 << 0);
        update_status_widget( event.target, bit0Set );
    }

    function updateSafetySwitchBoxStatusWidget( event )  {
        let status = parseInt( event.channelValue );

        // This test was taken from the caQtDm PROSCAN status display
        let bit3Set = ( status & (1 << 3) ) === (1 << 3);
        update_status_widget( event.target, bit3Set );
    }

    function update_status_widget( widget, isOK ) {
        if ( isOK ) {
            widget.style.backgroundColor = "lime";
        }
        else {
            widget.style.backgroundColor = "red";
        }
    }

    class CalculateHeizLeistung
    {
        constructor( calcDivId, channel1DataId, channel2DataId )
        {
            this.calculationOutputElement = document.getElementById( calcDivId );
            this.channel1DataElement = document.getElementById( channel1DataId );
            this.channel2DataElement = document.getElementById( channel2DataId );
            this.heizleistungChannel1 = 0.0;
            this.heizleistungChannel2 = 0.0;

            // Required to overcome Javascript's strange variable scoping rules
            let that = this;

            this.channel1DataElement.onchange = function( e )
            {
                that.heizleistungChannel1 = parseFloat( e.channelValue);
            };

            this.channel2DataElement.onchange = function( e )
            {
                that.heizleistungChannel2 = parseFloat( e.channelValue);
            };

            // Trigger a task to calculate the Heizlestung every second
            setInterval( CalculateHeizLeistung.updateOutputElement, 1000, that );
        }

        static updateOutputElement( that )
        {
            if ( ( that.heizleistungChannel1 === undefined ) || ( that.heizleistungChannel2 === undefined ) )
            {
                return;
            }
           that.calculationOutputElement.textContent = ( that.heizleistungChannel1 * that.heizleistungChannel2).toFixed( 2 ) + "W";
        }
    }

    let heizLeistungCalc;
    heizLeistungCalc = new CalculateHeizLeistung( "heizLeistungCalculator", "heizleistungDataId1", "heizleistungDataId2" );

    class PlotMainChart
    {
        constructor( plotDivId, plotTitle, beamCurrentDataId, vdefVoltageDataId, hfPowerDataId )
        {
            this.beamCurrentDataElement = document.getElementById( beamCurrentDataId );
            this.vdefVoltageDataElement = document.getElementById( vdefVoltageDataId );
            this.hfPowerDataElement = document.getElementById( hfPowerDataId );

            this.plotElement = document.getElementById( plotDivId );
            this.beamCurrent = undefined;
            this.vdefVoltage = undefined;

            this.hfPower = undefined;

            this.layout = {
                autosize: true,
                type: 'scatter',
                title: plotTitle,
                margin: {l: 60, r: 30, b: 40, t: 40, pad: 0},
                showlegend: true,
                legend: { x: 0, y: 1.2 },
                yaxis: { title: "MMAC3 Current (nA)", range: [0, 850]},
                xaxis: { autorange: true },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };

            // Required to overcome Javascript's strange variable scoping rules
            let that = this;

            this.beamCurrentDataElement.onchange = function( e )
            {
                that.beamCurrent = parseFloat( e.channelValue );
            };

            this.vdefVoltageDataElement.onchange = function( e )
            {
                // The goal of the scaling below is to convert the input value which
                // may go up to 2.2KV to a number that will fit in a sensible place
                // on the Y axis (which currently goes up to 850).
                that.vdefVoltage = parseFloat( e.channelValue ) * 1000 * (850 / 2200);
            };

            this.hfPowerDataElement.onchange = function( e )
            {
                // The goal of the scaling below is to convert the input value which
                // may go up to 130KW  to a number that will fit in a sensible place
                // on the Y axis (which currently goes up to 850).
                that.hfPower = parseFloat( e.channelValue) * (850 / 130);
            };

            this.timeArray = [];
            this.beamCurrentArray = [];
            this.vdefVoltageArray = [];
            this.hfPowerArray = [];
            this.nPoints = 0;

            // Update the main plot every two seconds
            setInterval( PlotMainChart.update_plot, 2000, that );
        }

        static update_plot( that )
        {
            if ( ( that.beamCurrent === undefined ) || ( that.vdefVoltage === undefined ) || ( that.hfPower === undefined )  )
            {
                return;
            }

            let timeNow = new Date();

            // It is important to update the layout data revision so that Plotly
            // knows it must perform a redraw operation.
            that.layout.datarevision= timeNow;

            that.timeArray.push( timeNow );
            that.beamCurrentArray.push( that.beamCurrent );
            that.vdefVoltageArray.push( that.vdefVoltage );
            that.hfPowerArray.push( that.hfPower );

            // keep the last 1800 points which roughly corresponds to 30 minutes
            if ( that.nPoints++ === 900 ) {
                 that.timeArray.shift();
                 that.beamCurrentArray.shift();
                 that.vdefVoltageArray.shift();
                 that.hfPowerArray.shift();
            }

            let trace1 = {
                name: 'MMAC3 (nA)',
                x: that.timeArray,
                y: that.beamCurrentArray,
                mode: 'lines+markers',
                marker: {size: 3, symbol: 'circle'},
                line: {color: '#00FF00', width: 3},
                fill: 'tozeroy'
            };

            let trace2 = {
                name: 'Deflector (rel)',
                x: that.timeArray,
                y: that.vdefVoltageArray,
                mode: 'lines+markers',
                marker: {size: 3, symbol: 'circle'},
                line: {color: '#0000FF', width: 3}
            };

            let trace3 = {
                name: 'HF (rel)',
                x: that.timeArray,
                y: that.hfPowerArray,
                mode: 'lines+markers',
                marker: {size: 3, symbol: 'circle'},
                line: {color: '#000000', width: 3}
            };

            let data = [trace1, trace2, trace3];
            Plotly.react( that.plotElement, data, that.layout );
        }
    }

    let mainPlot;
    mainPlot = new PlotMainChart("mainPlot", "MMAC3 / Deflector / HF", "mainPlotBeamCurrentData", "mainPlotVDefVoltageData", "mainPlotHFPowerData" );

    class PlotVerticalDeflector {

        constructor( plotDivId, plotTitle, xDataId, yDataId )
        {
            this.xDataElement = document.getElementById( xDataId );
            this.yDataElement = document.getElementById( yDataId );
            this.plotElement = document.getElementById( plotDivId );
            this.xAxisDataObj = undefined;
            this.yAxisDataObj = undefined;

            this.layout = {
                autosize: true,
                title: plotTitle,
                margin: {l: 50, r: 30, b: 30, t: 30, pad: 0},
                xaxis: {title: "Vdef (kV)"},
                yaxis: {
                    title: "MMAC3 (nA)",
                    tickmode: 'auto',
                    nticks: 5
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };

            // Required to overcome Javascript's strange variable scoping rules
            let that = this;

            this.xDataElement.onchange = function ( e ) {
                that.xAxisDataObj = JSON.parse( e.channelValue );
            };
            this.yDataElement.onchange = function ( e ) {
                that.yAxisDataObj = JSON.parse( e.channelValue );
            };

            setInterval( PlotVerticalDeflector.update_plot, 2000, that );
        }

        static update_plot( that )
        {
            if ( ( that.xAxisDataObj === undefined ) || ( that.yAxisDataObj === undefined ) )
            {
                return;
            }

            let trace = {
                y: JSON.parse( that.xAxisDataObj.data ),
                x: JSON.parse( that.yAxisDataObj.data ),
                type: 'scatter',
                mode: 'lines+markers',
                marker: {size: 6, symbol: 'circle'}
            };

            let data = [trace];
            Plotly.react( that.plotElement, data, that.layout, {displayModeBar: false} );
        }
    }

    let vdefPlot;
    vdefPlot = new PlotVerticalDeflector("vdefPlot", "Comet Deflector Curve", "vdefPlotDataX", "vdefPlotDataY");

    class PlotProfileMonitor
    {
        constructor( plotDivId, plotTitle, xDataId, yDataId )
        {
            this.xDataElement = document.getElementById( xDataId );
            this.yDataElement = document.getElementById( yDataId );
            this.plotElement = document.getElementById( plotDivId );
            this.xAxisDataObj = undefined;
            this.yAxisDataObj = undefined;

            this.layout = {
                autosize: true,
                title: plotTitle,
                margin: { l: 40, r: 10, b: 30, t: 30, pad: 0 },
                xaxis: {
                    range: [-32, 32],
                    tick0: 0,
                    dtick: 10,
                    tickwidth: 2
                },
                yaxis: {
                    autorange: true,
                    tickmode: 'auto',
                    nticks: 5
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };

            // Required to overcome Javascript's strange variable scoping rules
            let that = this;

            this.xDataElement.onchange = function ( e ) {
                that.xAxisDataObj = JSON.parse( e.channelValue );
            };

            this.yDataElement.onchange = function ( e ) {
                that.yAxisDataObj = JSON.parse( e.channelValue );
            };

            setInterval( this.update_plot, 2000, that );
        }

        update_plot( that )
        {
            if ( ( that.xAxisDataObj === undefined ) || ( that.yAxisDataObj === undefined ) )
            {
                return;
            }

            let trace = {
                x: JSON.parse( that.xAxisDataObj.data ),
                y: JSON.parse( that.yAxisDataObj.data ),
                type: 'scatter',
                mode: 'lines+markers',
                fill: 'tozeroy',
                marker: {size: 6, symbol: 'circle'}
            };

            let data = [trace];
            Plotly.react( that.plotElement, data, that.layout, { displayModeBar: false});
        }
    }

    let mmap5xPlot;
    mmap5xPlot = new PlotProfileMonitor("mmap5xPlot", "MMAP5X", "mmap5xPlotDataX", "mmap5xPlotDataY");
    let mmap6yPlot;
    mmap6yPlot = new PlotProfileMonitor("mmap6yPlot", "MMAP6Y", "mmap6yPlotDataX", "mmap6yPlotDataY");

</script>
</body>

</html>
